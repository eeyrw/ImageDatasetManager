<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>瀑布流分页示例（支持跳转页、选择页大小和加载中提示）</title>
  <script src="https://cdn.jsdelivr.net/npm/macy@2.5.1/dist/macy.min.js"></script>
  <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #fafafa; }
    #nav-bar {
      position: fixed; top: 16px; right: 16px; background: #fffcccee;
      border: 1px solid #ccc; border-radius: 12px; padding: 10px 14px;
      z-index: 999; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex; align-items: center; gap: 8px;
      flex-wrap: wrap;
    }
    #image-container { margin: 120px 16px 32px 16px; }
    .image-item img {
      width: 100%; display: block; border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    button { padding: 6px 12px; font-size: 14px; border-radius: 6px; cursor: pointer; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    label { font-size: 14px; }
    input[type="number"] {
      width: 60px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    select {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    /* 加载中提示样式 */
    #loading {
      display: none;
      position: fixed;
      top: 60px;
      right: 16px;
      background: #000000cc;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 1000;
      user-select: none;
    }
  </style>
</head>
<body>

<div id="nav-bar">
  <button id="prev-page">上一页</button>

  <label for="goto-page">跳转到第</label>
  <input id="goto-page" type="number" min="1" step="1" value="1" />
  <label>页</label>

  <span id="page-info"> / 共 1 页</span>

  <label for="page-size">每页显示</label>
  <select id="page-size">
    <option value="10">10</option>
    <option value="20" selected>20</option>
    <option value="30">30</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select>
  <label>张图片</label>

  <button id="next-page">下一页</button>
</div>

<div id="loading">加载中...</div>

<div id="image-container"></div>

<script>
  let currentPage = 0;  // 0基页码
  let pageSize = 20;
  let totalPages = 1;
  let macy = null;

  function initMasonry() {
    macy = Macy({
      container: '#image-container',
      trueOrder: false,
      waitForImages: true,
      margin: 16,
      columns: 6,
      breakAt: {
        1600: 6,   // 超大屏幕（4K）显示 6 列
        1200: 5,   // 桌面宽屏显示 5 列
        992: 4,    // 标准桌面显示 4 列
        768: 3,    // 平板横屏显示 3 列
        576: 2,    // 手机横屏 2 列
        0: 1       // 手机竖屏 1 列
      }
    });
  }

  function showLoading() {
    document.getElementById('loading').style.display = 'block';
  }
  function hideLoading() {
    document.getElementById('loading').style.display = 'none';
  }

  async function fetchImagePage(page, size) {
    const res = await fetch(`/api/images?page=${page}&size=${size}`);
    return await res.json();
  }

  async function loadPage(page) {
    showLoading();
    try {
      const container = document.getElementById('image-container');
      container.innerHTML = '';  // 清空旧图片
      const data = await fetchImagePage(page, pageSize);

      totalPages = Math.max(1, Math.ceil(data.total / pageSize));
      if (data.images.length === 0 && page > 0) {
        alert('没有更多图片了！');
        hideLoading();
        return false;
      }
      data.images.forEach(url => {
        const div = document.createElement('div');
        div.className = 'image-item';
        const img = document.createElement('img');
        img.src = url;
        img.loading = 'lazy';
        div.appendChild(img);
        container.appendChild(div);
      });
      imagesLoaded(container, () => {
        macy.recalculate(true);
        hideLoading();
      });

      currentPage = page;
      document.getElementById('goto-page').value = currentPage + 1;
      document.getElementById('page-info').textContent = ` / 共 ${totalPages} 页`;
      updateButtons();
      return true;
    } catch(e) {
      hideLoading();
      alert('加载失败，请重试');
      return false;
    }
  }

  function updateButtons() {
    document.getElementById('prev-page').disabled = (currentPage === 0);
    document.getElementById('next-page').disabled = (currentPage + 1 >= totalPages);
  }

  document.getElementById('prev-page').addEventListener('click', async () => {
    if (currentPage === 0) return;
    await loadPage(currentPage - 1);
  });

  document.getElementById('next-page').addEventListener('click', async () => {
    if (currentPage + 1 >= totalPages) return;
    await loadPage(currentPage + 1);
  });

  // 跳转输入框处理（回车跳转）
  document.getElementById('goto-page').addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') {
      let val = parseInt(e.target.value);
      if (isNaN(val) || val < 1) val = 1;
      if (val > totalPages) val = totalPages;
      await loadPage(val - 1);
    }
  });

  // 每页大小选择处理
  document.getElementById('page-size').addEventListener('change', async (e) => {
    pageSize = parseInt(e.target.value);
    await loadPage(0);  // 换页大小后跳回第一页
  });

  // 初始化
  initMasonry();
  loadPage(currentPage);
</script>

</body>
</html>
